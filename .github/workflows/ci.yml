name: CI

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  KACHE_LOG: kache=debug

jobs:
  check:
    name: Check (${{ matrix.os }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: Linux
            runner: ubuntu-latest
          # TODO: re-enable once macOS runners are available
          # - os: macOS
          #   runner: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: kunobi-ninja/kache-action@v1
        with:
          github-cache: "true"
          cache-executables: "false"
      - run: cargo fmt -- --check
      - run: cargo clippy -- -D warnings
      - name: Install tarpaulin
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-tarpaulin
      - name: Test with coverage
        run: cargo tarpaulin --engine llvm --all-features --workspace --out Json
        env:
          RUSTC_WRAPPER: ""
      - name: Check coverage threshold (25%)
        run: |
          python3 -c "
          import json, sys
          data = json.load(open('tarpaulin-report.json'))
          coverage = data['coverage']
          threshold = 25.0
          print(f'Coverage: {coverage:.1f}%')
          if coverage < threshold:
              print(f'FAIL: below threshold {threshold}%')
              sys.exit(1)
          print(f'OK: >= {threshold}%')
          "

  # --- Release (only on v* tags) ---
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [check]
    uses: zondax/_workflows/.github/workflows/_release-rust.yml@main
    with:
      binary_name: kache
      runner_macos: '["self-hosted", "macOS", "ARM64"]'
      extra_build_env: |
        KACHE_VERSION=${{ github.ref_name }}
    permissions:
      contents: write
